window.wp=window.wp||{},function(e){var t,i;(t=wp.demos=wp.demos||{}).data=_demoImporterSettings,i=t.data.l10n,t.isNew=!!t.data.settings.isNew,_.extend(t,{model:{},view:{},routes:{},router:{},template:wp.template}),t.Model=Backbone.Model.extend({initialize:function(){var e;this.set({id:this.get("slug")||this.get("id")}),this.has("sections")&&(e=this.get("sections").description,this.set({description:e}))}}),t.view.Appearance=wp.Backbone.View.extend({el:"#wpbody-content .wrap .theme-browser",window:e(window),page:0,initialize:function(e){_.bindAll(this,"scroller"),this.SearchView=e.SearchView?e.SearchView:t.view.Search,this.window.bind("scroll",_.throttle(this.scroller,300))},render:function(){this.view=new t.view.Demos({collection:this.collection,parent:this}),this.search(),this.$el.removeClass("search-loading"),this.view.render(),this.$el.empty().append(this.view.el).addClass("rendered")},searchContainer:e(".search-form"),search:function(){var r;1!==t.data.demos.length&&(r=new this.SearchView({collection:this.collection,parent:this}),this.SearchView=r,r.render(),this.searchContainer.append(e.parseHTML('<label class="screen-reader-text" for="wp-filter-search-input">'+i.search+"</label>")).append(r.el).on("submit",function(e){e.preventDefault()}))},scroller:function(){var e;this.window.scrollTop(),this.window.height(),e=this.$el.offset().top+this.$el.outerHeight(!1)-this.window.height(),e=Math.round(.9*e)}}),t.Collection=Backbone.Collection.extend({model:t.Model,terms:"",doSearch:function(i){this.terms!==i&&(this.terms=i,this.terms.length>0&&this.search(this.terms),""===this.terms&&(this.reset(t.data.demos),e("body").removeClass("no-results")),this.trigger("demos:update"))},search:function(i){var r,s,o,n,a,l;this.reset(t.data.demos,{silent:!0}),i=(i=i.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")).replace(/ /g,")(?=.*"),r=new RegExp("^(?=.*"+i+").+","i"),0===(s=this.filter(function(e){return n=e.get("name").replace(/(<([^>]+)>)/gi,""),a=e.get("description").replace(/(<([^>]+)>)/gi,""),l=e.get("author").replace(/(<([^>]+)>)/gi,""),o=_.union([n,e.get("id"),a,l,e.get("tags")]),r.test(e.get("author"))&&i.length>2&&e.set("displayAuthor",!0),r.test(o)})).length?this.trigger("query:empty"):e("body").removeClass("no-results"),this.reset(s)},paginate:function(e){var t=this;return e=e||0,t=_(t.rest(20*e)),t=_(t.first(20))},count:!1,query:function(t){var i,r,s,o=this.queries,n=this;if(this.currentQuery.request=t,i=_.find(o,function(e){return _.isEqual(e.request,t)}),(r=_.has(t,"page"))||(this.currentQuery.page=1),i||r){if(r)return this.apiCall(t,r).done(function(e){n.add(e.demos),n.trigger("query:success"),n.loadingDemos=!1}).fail(function(){n.trigger("query:fail")});0===i.demos.length?n.trigger("query:empty"):e("body").removeClass("no-results"),_.isNumber(i.total)&&(this.count=i.total),this.reset(i.demos),i.total||(this.count=this.length),this.trigger("demos:update"),this.trigger("query:success",this.count)}else i=this.apiCall(t).done(function(e){e.demos&&(n.reset(e.demos),s=e.info.results,o.push({demos:e.demos,request:t,total:s})),n.trigger("demos:update"),n.trigger("query:success",s),e.demos&&0===e.demos.length&&n.trigger("query:empty")}).fail(function(){n.trigger("query:fail")})},queries:[],currentQuery:{page:1,request:{}},apiCall:function(t,i){return wp.ajax.send("query-demos",{data:{request:_.extend({per_page:100},t)},beforeSend:function(){i||e("body").addClass("loading-content").removeClass("no-results")}})},loadingDemos:!1}),t.view.Demo=wp.Backbone.View.extend({className:"theme",state:"grid",html:t.template("demo"),events:{click:"preview",keydown:"preview",touchend:"preview",keyup:"addFocus",touchmove:"preventExpand","click .demo-import":"importDemo"},touchDrag:!1,initialize:function(){this.model.on("change",this.render,this)},render:function(){var e=this.model.toJSON();this.$el.html(this.html(e)).attr({tabindex:0,"aria-describedby":e.id+"-action "+e.id+"-name","data-slug":e.id}),this.activeDemo(),this.model.get("displayAuthor")&&this.$el.addClass("display-author")},activeDemo:function(){this.model.get("active")&&this.$el.addClass("active")},addFocus:function(){var t=e(":focus").hasClass("theme")?e(":focus"):e(":focus").parents(".theme");e(".theme.focus").removeClass("focus"),t.addClass("focus")},preventExpand:function(){this.touchDrag=!0},preview:function(i){var r,s,o=this;if(i=i||window.event,!0===this.touchDrag)return this.touchDrag=!1;e(i.target).not(".install-demo-preview").parents(".theme-actions").length||"keydown"===i.type&&13!==i.which&&32!==i.which||"keydown"===i.type&&13!==i.which&&e(":focus").hasClass("button")||(i.preventDefault(),i=i||window.event,t.focusedDemo=this.$el,t.preview=s=new t.view.Preview({model:this.model}),s.render(),this.setNavButtonsState(),1===this.model.collection.length?s.$el.addClass("no-navigation"):s.$el.removeClass("no-navigation"),e("div.wrap").append(s.el),this.listenTo(s,"demo:next",function(){if(r=o.model,_.isUndefined(o.current)||(r=o.current),o.current=o.model.collection.at(o.model.collection.indexOf(r)+1),_.isUndefined(o.current))return o.options.parent.parent.trigger("demo:end"),o.current=r;s.model=o.current,s.render(),this.setNavButtonsState(),e(".next-theme").focus()}).listenTo(s,"demo:previous",function(){r=o.model,0!==o.model.collection.indexOf(o.current)&&(_.isUndefined(o.current)||(r=o.current),o.current=o.model.collection.at(o.model.collection.indexOf(r)-1),_.isUndefined(o.current)||(s.model=o.current,s.render(),this.setNavButtonsState(),e(".previous-theme").focus()))}),this.listenTo(s,"preview:close",function(){o.current=o.model}))},setNavButtonsState:function(){var t=e(".theme-install-overlay"),i=_.isUndefined(this.current)?this.model:this.current,r=t.find(".previous-theme"),s=t.find(".next-theme");0===this.model.collection.indexOf(i)&&(r.addClass("disabled").prop("disabled",!0),s.focus()),_.isUndefined(this.model.collection.at(this.model.collection.indexOf(i)+1))&&(s.addClass("disabled").prop("disabled",!0),r.focus())},importDemo:function(t){var i=this,r=e(t.target),s=e(t.target).data("plugins");t.preventDefault(),r.hasClass("disabled")||r.hasClass("updating-message")||window.confirm(wp.demos.data.settings.confirmImport)&&(wp.updates.maybeRequestFilesystemCredentials(t),e(document).trigger("wp-plugin-bulk-install",s),e.each(s,function(e,t){t.is_active||wp.updates.queue.push({action:"install-plugin",data:{plugin:t.slug,name:t.name,slug:e,demo:r.data("slug")}})}),e(document).on("wp-demo-import-success",function(e,t){i.model.get("id")===t.slug&&(i.render(),i.model.set({imported:!0}))}),wp.updates.queue.push({action:"import-demo",data:{slug:r.data("slug")}}),wp.updates.queueChecker())}}),t.view.Preview=wp.Backbone.View.extend({className:"wp-full-overlay expanded",el:".theme-install-overlay",events:{"click .close-full-overlay":"close","click .collapse-sidebar":"collapse","click .devices button":"previewDevice","click .previous-theme":"previousDemo","click .next-theme":"nextDemo",keyup:"keyEvent","click .demo-import":"importDemo"},html:t.template("demo-preview"),render:function(){var i,r=this,s=this.model.toJSON(),o=e(document.body);o.attr("aria-busy","true"),this.$el.removeClass("iframe-ready").html(this.html(s)),(i=this.$el.data("current-preview-device"))&&r.tooglePreviewDeviceButtons(i),t.router.navigate(t.router.baseUrl(t.router.demoPath+this.model.get("id")),{replace:!1}),this.$el.fadeIn(200,function(){o.addClass("demo-importer-active full-overlay-active")}),this.$el.find("iframe").one("load",function(){r.iframeLoaded()})},iframeLoaded:function(){this.$el.addClass("iframe-ready"),e(document.body).attr("aria-busy","false")},close:function(){return this.$el.fadeOut(200,function(){e("body").removeClass("demo-importer-active full-overlay-active"),t.focusedDemo&&t.focusedDemo.focus()}).removeClass("iframe-ready"),t.router.selectedTab?t.router.navigate(t.router.baseUrl("&browse="+t.router.selectedTab)):t.router.navigate(t.router.baseUrl("")),this.trigger("preview:close"),this.undelegateEvents(),this.unbind(),!1},collapse:function(t){var r=e(t.currentTarget);return"true"===r.attr("aria-expanded")?r.attr({"aria-expanded":"false","aria-label":i.expandSidebar}):r.attr({"aria-expanded":"true","aria-label":i.collapseSidebar}),this.$el.toggleClass("collapsed").toggleClass("expanded"),!1},previewDevice:function(t){var i=e(t.currentTarget).data("device");this.$el.removeClass("preview-desktop preview-tablet preview-mobile").addClass("preview-"+i).data("current-preview-device",i),this.tooglePreviewDeviceButtons(i)},tooglePreviewDeviceButtons:function(t){var i=e(".wp-full-overlay-footer .devices");i.find("button").removeClass("active").attr("aria-pressed",!1),i.find("button.preview-"+t).addClass("active").attr("aria-pressed",!0)},keyEvent:function(e){27===e.keyCode&&(this.undelegateEvents(),this.close()),39===e.keyCode&&_.once(this.nextDemo()),37===e.keyCode&&this.previousDemo()},nextDemo:function(){return this.trigger("demo:next",this.model.cid),!1},previousDemo:function(){return this.trigger("demo:previous",this.model.cid),!1},importDemo:function(t){var i=this,r=e(t.target),s=e(".plugins-list-table").find("#the-list tr"),o=0,n=0,a=[];t.preventDefault(),r.hasClass("disabled")||r.hasClass("updating-message")||window.confirm(wp.demos.data.settings.confirmImport)&&(wp.updates.maybeRequestFilesystemCredentials(t),e(".theme-install-overlay").find(".next-theme, .previous-theme").addClass("disabled"),e(document).trigger("wp-plugin-bulk-install",s),s.each(function(t,i){var s=e(i);s.hasClass("inactive")&&!s.find("notice-error").length&&wp.updates.queue.push({action:"install-plugin",data:{plugin:s.data("plugin"),slug:s.data("slug"),demo:r.data("slug")}})}),e(document).on("wp-plugin-bulk-installing",function(){e(".wp-full-overlay-sidebar-content").animate({scrollTop:e(document).height()})}),e(document).on("wp-plugin-bulk-install-success wp-plugin-bulk-install-error",function(t,s){var l,c,d=e('[data-slug="'+s.slug+'"]');"wp-"+s.install+"-bulk-install-success"===t.type?o++:(c=s.pluginName?s.pluginName:d.find(".plugin-name").text(),n++,a.push(c+": "+s.errorMessage)),wp.updates.adminNotice=wp.template("wp-bulk-installs-admin-notice"),e(".plugins-details .bulk-action-notice").remove(),e(".plugins-details .plugins-info").after(wp.updates.adminNotice({id:"bulk-action-notice",className:"bulk-action-notice notice-alt",successes:o,errors:n,errorMessages:a,type:s.install})),l=e("#bulk-action-notice").on("click","button",function(){e(this).toggleClass("bulk-action-errors-collapsed").attr("aria-expanded",!e(this).hasClass("bulk-action-errors-collapsed")),l.find(".bulk-action-errors").toggleClass("hidden")}),wp.updates.queue.length||(n>0?r.removeClass("updating-message").text(r.data("originaltext")):(i.model.set({requiredPlugins:!1}),e(".theme-install-overlay").find(".next-theme, .previous-theme").addClass("disabled")))}),e(document).on("wp-updates-notice-added",function(){wp.updates.adminNotice=wp.template("wp-updates-admin-notice")}),e(document).on("wp-demo-import-success",function(e,t){i.model.get("id")===t.slug&&i.model.set({imported:!0})}),wp.updates.queue.push({action:"import-demo",data:{slug:r.data("slug")}}),wp.updates.queueChecker())}}),t.view.Demos=wp.Backbone.View.extend({className:"themes wp-clearfix",$overlay:e("div.theme-overlay"),index:0,count:e(".wrap .demo-count"),liveDemoCount:0,initialize:function(t){var i=this;this.parent=t.parent,this.setView("grid"),i.importedDemo(),this.listenTo(i.collection,"demos:update",function(){i.parent.page=0,i.importedDemo(),i.render(this)}),this.listenTo(i.collection,"query:success",function(e){_.isNumber(e)?(i.count.text(e),i.announceSearchResults(e)):(i.count.text(i.collection.length),i.announceSearchResults(i.collection.length))}),this.listenTo(i.collection,"query:empty",function(){e("body").addClass("no-results")}),this.listenTo(this.parent,"demo:scroll",function(){i.renderDemos(i.parent.page)})},render:function(){this.$el.empty(),this.options.collection.size()>0&&this.renderDemos(this.parent.page),this.liveDemoCount=this.collection.count?this.collection.count:this.collection.length,this.count.text(this.liveDemoCount)},renderDemos:function(r){var s=this;s.instance=s.collection.paginate(r),0!==s.instance.size()?(t.isNew&&r>=1&&e(".add-new-theme").remove(),s.instance.each(function(e){s.demo=new t.view.Demo({model:e,parent:s}),s.demo.render(),s.$el.append(s.demo.el)}),t.isNew&&t.data.settings.suggestURI&&this.$el.append('<div class="theme add-new-theme"><a href="'+t.data.settings.suggestURI+'" target="blank"><div class="theme-screenshot"><span></span></div><h2 class="theme-name">'+i.suggestNew+"</h2></a></div>"),this.parent.page++):this.parent.trigger("demo:end")},importedDemo:function(){var e;(e=this.collection.findWhere({active:!0}))&&(this.collection.remove(e),this.collection.add(e,{at:0}))},setView:function(e){return e},announceSearchResults:function(e){0===e?wp.a11y.speak(i.noDemosFound):wp.a11y.speak(i.demosFound.replace("%d",e))}}),t.view.Search=wp.Backbone.View.extend({tagName:"input",className:"wp-filter-search",id:"wp-filter-search-input",searching:!1,attributes:{placeholder:i.searchPlaceholder,type:"search","aria-describedby":"live-search-desc"},events:{input:"search",keyup:"search",blur:"pushState"},initialize:function(e){this.parent=e.parent,this.listenTo(this.parent,"demo:close",function(){this.searching=!1})},search:function(e){"keyup"===e.type&&27===e.which&&(e.target.value=""),this.doSearch(e)},doSearch:function(e){var i={};this.collection.doSearch(e.target.value.replace(/\+/g," ")),this.searching&&13!==e.which?i.replace=!0:this.searching=!0,e.target.value?t.router.navigate(t.router.baseUrl(t.router.searchPath+e.target.value),i):t.router.navigate(t.router.baseUrl(""))},pushState:function(e){var i=t.router.baseUrl("");e.target.value&&(i=t.router.baseUrl(t.router.searchPath+encodeURIComponent(e.target.value))),this.searching=!1,t.router.navigate(i)}}),t.Router=Backbone.Router.extend({routes:{"themes.php?page=demo-importer&demo=:slug":"preview","themes.php?page=demo-importer&browse=:sort":"sort","themes.php?page=demo-importer&search=:query":"search","themes.php?page=demo-importer":"sort"},baseUrl:function(e){return"themes.php?page=demo-importer"+e},demoPath:"&demo=",browsePath:"&browse=",searchPath:"&search=",search:function(t){e(".wp-filter-search").val(t.replace(/\+/g," "))},navigate:function(e,t){Backbone.history._hasPushState&&Backbone.Router.prototype.navigate.call(this,e,t)}}),t.view.InstallerSearch=t.view.Search.extend({events:{input:"search",keyup:"search"},terms:"",search:function(e){("keyup"!==e.type||9!==e.which&&16!==e.which)&&(this.collection=this.options.parent.view.collection,"keyup"===e.type&&27===e.which&&(e.target.value=""),this.doSearch(e.target.value))},doSearch:function(i){this.terms!==i&&(this.terms=i,e(".filter-links li > a.current").removeClass("current").removeAttr("aria-current"),this.collection.doSearch(i.replace(/\+/g," ")),t.router.navigate(t.router.baseUrl(t.router.searchPath+encodeURIComponent(i)),{replace:!0}))}}),t.view.Installer=t.view.Appearance.extend({el:"#wpbody-content .wrap",events:{"click .filter-links li > a":"onSort"},render:function(){var r=this;this.search(),this.collection=new t.Collection,this.listenTo(this,"demo:end",function(){r.collection.loadingDemos||(r.collection.loadingDemos=!0,r.collection.currentQuery.page++,_.extend(r.collection.currentQuery.request,{page:r.collection.currentQuery.page}),r.collection.query(r.collection.currentQuery.request))}),this.listenTo(this.collection,"query:success",function(){e("body").removeClass("loading-content"),e(".theme-browser").find("div.error").remove()}),this.listenTo(this.collection,"query:fail",function(){e("body").removeClass("loading-content"),e(".theme-browser").find("div.error").remove(),e(".theme-browser").find("div.themes").before('<div class="error"><p>'+i.error+'</p><p><button class="button try-again">'+i.tryAgain+"</button></p></div>"),e(".theme-browser .error .try-again").on("click",function(t){t.preventDefault(),e("input.wp-filter-search").trigger("input")})}),this.view&&this.view.remove(),this.view=new t.view.Demos({collection:this.collection,parent:this}),this.page=0,this.$el.find(".themes").remove(),this.view.render(),this.$el.find(".theme-browser").append(this.view.el).addClass("rendered")},browse:function(e,t){this.collection.query({browse:e,builder:t})},onSort:function(i){var r=e(i.target),s=r.data("sort"),o=r.data("type");i.preventDefault(),s=s||t.router.selectedTab,o=o||t.router.selectedType,r.hasClass(this.activeClass)||(this.sort(s,o),t.router.navigate(t.router.baseUrl(t.router.browsePath+s)))},sort:function(i,r){this.clearSearch(),t.router.selectedTab=i,t.router.selectedType=r,e(".filter-links li > a").removeClass(this.activeClass).removeAttr("aria-current"),e('[data-sort="'+i+'"]').addClass(this.activeClass).attr("aria-current","page"),e('[data-type="'+r+'"]').addClass(this.activeClass).attr("aria-current","page"),this.browse(i,r)},activeClass:"current",clearSearch:function(){e("#wp-filter-search-input").val("")}}),t.RunInstaller={init:function(){this.view=new t.view.Installer({section:"all",SearchView:t.view.InstallerSearch}),this.render(),this.view.SearchView.doSearch=_.debounce(this.view.SearchView.doSearch,500)},render:function(){this.view.render(),this.routes(),Backbone.History.started&&Backbone.history.stop(),Backbone.history.start({root:t.data.settings.adminUrl,pushState:!0,hashChange:!1})},routes:function(){var i=this,r={};t.router=new t.Router,t.router.on("route:preview",function(s){t.preview&&(t.preview.undelegateEvents(),t.preview.unbind()),i.view.view.demo&&i.view.view.demo.preview?(i.view.view.demo.model=i.view.collection.findWhere({slug:s}),i.view.view.demo.preview()):(r.demo=s,i.view.collection.query(r),i.view.collection.trigger("update"),i.view.collection.once("query:success",function(){e('div[data-slug="'+s+'"]').trigger("click")}))}),t.router.on("route:sort",function(r){var s=t.router.selectedType?t.router.selectedType:e(".filter-links.pagebuilders li").first().find("a").data("type");r&&e('[data-sort="'+r+'"]').length||(r="all",t.router.navigate(t.router.baseUrl("&browse=all"),{replace:!0})),i.view.sort(r,s),t.preview&&t.preview.close()}),t.router.on("route:search",function(){e(".wp-filter-search").focus().trigger("keyup")}),this.extraRoutes()},extraRoutes:function(){return!1}},e(document).ready(function(){t.RunInstaller.init(),e(".filter-links li").each(function(t){0==t&&e(this).find("a").click()}),e(document.body).on("init_tooltips",function(){e("#tiptip_holder").removeAttr("style"),e("#tiptip_arrow").removeAttr("style"),e(".tips").tipTip({attribute:"data-tip",defaultPosition:"top",fadeIn:50,fadeOut:50,delay:50})}).trigger("init_tooltips"),e(".bstone-reset-wordpress").on("click",function(){return window.confirm(_demoImporterSettings.settings.confirmReset)}),e(".bstone-demo-importer-rating-link").on("click",function(){var i=e(this);e.post(t.data.settings.ajaxUrl,{action:"footer-text-rated"}),i.parent().text(i.data("rated"))})})}(jQuery);